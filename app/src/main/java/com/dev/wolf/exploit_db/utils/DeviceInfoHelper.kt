package com.dev.wolf.exploit_db.utils

import android.Manifest
import android.annotation.SuppressLint
import android.content.Context
import android.content.pm.PackageManager
import android.os.Build.*
import android.os.Build.VERSION.RELEASE
import android.os.Build.VERSION.SDK_INT
import android.telephony.TelephonyManager
import androidx.core.content.ContextCompat
import com.dev.wolf.exploit_db.R

class DeviceInfoHelper(val context: Context) {

    private val model = deviceModel
    private val hardware: String? = HARDWARE
    private val version: String? = RELEASE
    private val apiLevel = SDK_INT
    private val id: String? = ID
    private val display: String? = DISPLAY

    private val deviceModel
        @SuppressLint("DefaultLocale")
        get() = capitalize(
            if (MODEL.lowercase().startsWith(MANUFACTURER.lowercase())) {
                MODEL
            } else {
                "$MANUFACTURER $MODEL"
            })


    private fun capitalize(str: String) = str.apply {
        if (isNotEmpty()) {
            first().run { if (isLowerCase()) lowercase() }
        }
    }

    private val Context.imei
        @SuppressLint("HardwareIds", "MissingPermission")
        get() = telephonyManager?.run {
            if (isReadPhoneStatePermissionGranted()) {
                if (SDK_INT >= VERSION_CODES.O) {
                    imei
                } else {
                    deviceId
                }
            } else DEFAULT_DEVICE_ID
        } ?: DEFAULT_DEVICE_ID

    private fun Context.isReadPhoneStatePermissionGranted() =
        ContextCompat.checkSelfPermission(
            this,
            Manifest.permission.READ_PHONE_STATE
        ) == PackageManager.PERMISSION_GRANTED

    private val Context.telephonyManager
        get() = getSystemService(Context.TELEPHONY_SERVICE) as TelephonyManager?

    companion object {
        const val DEFAULT_DEVICE_ID = "---"
    }

    fun getDeviceInfoLog() : String {
        return buildString {
            appendLine("-----Device info-----")
            appendLine("model : $model")
            appendLine("id : $id")
            appendLine("hardware : $hardware")
            appendLine("version : $version")
            appendLine("api level : $apiLevel")
            appendLine("display : $display")
            appendLine("is tablet : ${context.resources.getBoolean(R.bool.is_tablet)}")
            appendLine("-----Device info-----")
            appendLine()
        }
    }
}