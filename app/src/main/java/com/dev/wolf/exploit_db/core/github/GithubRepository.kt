package com.dev.wolf.exploit_db.core.github

import com.dev.wolf.exploit_db.utils.ext.await
import com.dev.wolf.exploit_db.utils.ext.parseJson
import okhttp3.OkHttpClient
import okhttp3.Request

class GithubRepository(private val okHttp: OkHttpClient) {

    suspend fun getLatestVersion(): AppVersion {
        val request = Request.Builder()
            .get()
            .url("https://api.github.com/repos/gaiththewolf/Exploitdb/releases/latest")
        val json = okHttp.newCall(request.build()).await().parseJson()
        val asset = json.getJSONArray("assets").getJSONObject(0)
        return AppVersion(
            id = json.getLong("id"),
            url = json.getString("html_url"),
            name = json.getString("name").removePrefix("v"),
            apkSize = asset.getLong("size"),
            apkUrl = asset.getString("browser_download_url"),
            description = json.getString("body")
        )
    }
}